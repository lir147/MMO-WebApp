<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>RPG Персонаж</title>
    <style>
        :root {
            --dark-bg: #0f172a;
            --panel-bg: #1e293b;
            --accent: #3b82f6;
            --accent-dark: #2563eb;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --health: #ef4444;
            --mana: #6366f1;
            --xp: #10b981;
            --strength: #f59e0b;
            --agility: #10b981;
            --vitality: #ef4444;
            --intellect: #3b82f6;
            --locked: #475569;
            --gold: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body {
            background: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            background-image:
                radial-gradient(circle at 15% 50%, rgba(30, 41, 59, 0.4) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(30, 41, 59, 0.4) 0%, transparent 25%);
        }

        .container { max-width: 1200px; margin: 0 auto; }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--panel-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .character-info { display: flex; align-items: center; gap: 15px; }
        #header-avatar { display:flex; align-items:center; justify-content:center; width:64px; height:64px; border-radius:12px; background:#111827; overflow:hidden; }
        #header-avatar img { width: 100%; height: 100%; object-fit: cover; display:block; }

        .header-text h1 { font-size: 1.5rem; margin-bottom: 5px; color: var(--accent); }
        .header-text div { color: var(--text-muted); }

        .gold-display { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; font-weight: bold; color: var(--gold); background: rgba(245, 158, 11, 0.1); padding: 10px 15px; border-radius: 8px; }
        .gold-display span { display: inline-flex; align-items: center; }

        h1 { font-size: 2.5rem; margin-bottom: 10px; color: var(--accent); text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 20px; background: var(--panel-bg); border-radius: 12px; overflow: hidden; }
        .tab-btn { flex: 1; padding: 15px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; transition: all 0.3s ease; font-weight: bold; }
        .tab-btn:hover { background: rgba(59, 130, 246, 0.1); color: var(--text); }
        .tab-btn.active { background: var(--accent); color: white; }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Character Creation */
        .character-creation { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }

        .creation-panel { background: var(--panel-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }
        .creation-panel h2 { margin-bottom: 20px; color: var(--accent); border-bottom: 2px solid var(--accent); padding-bottom: 10px; }

        .nickname-input { margin-bottom: 20px; }
        .nickname-input label { display: block; margin-bottom: 8px; font-weight: bold; }

        .nickname-input input {
            width: 100%; padding: 12px;
            background: rgba(30, 41, 59, 0.7);
            border: 2px solid #334155;
            border-radius: 8px; color: var(--text); font-size: 1rem;
        }
        .nickname-input input:focus { outline: none; border-color: var(--accent); }

        .class-grid, .gender-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .class-option, .gender-option {
            background: rgba(30, 41, 59, 0.7); border: 2px solid #334155; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease;
        }
        .class-option:hover, .gender-option:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .class-option.selected, .gender-option.selected { border-color: var(--accent); background: rgba(59, 130, 246, 0.2); box-shadow: 0 0 15px rgba(59,130,246,0.5); }

        .class-icon { font-size: 2.5rem; margin-bottom: 10px; }

        .character-preview { margin-top: 20px; padding-top: 20px; border-top: 1px solid #334155; }
        .character-preview h3 { margin-bottom: 15px; color: var(--accent); }
        .preview-content { display: flex; align-items: center; gap: 15px; }
        #character-avatar { font-size: 3rem; }

        #character-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        #character-level { color: var(--text-muted); }

        /* Stats Panel */
        .character-sheet { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }

        .stats-panel { background: var(--panel-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }

        .character-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #334155; }

        #stats-avatar { font-size: 3rem; position: relative; }
        .equipment-slots { position: absolute; font-size: 0.8rem; background: rgba(0,0,0,0.7); border-radius: 4px; padding: 2px 5px; }

        #weapon-slot { top: 0; right: -5px; }
        #armor-slot { bottom: 0; right: -5px; }
        #amulet-slot { top: -6px; left: -6px; }

        #stats-name { font-size: 1.2rem; font-weight: bold; }

        .resource-bar { margin-bottom: 20px; }
        .bar-label { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .bar { height: 20px; background: #334155; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width 0.3s ease; }

        .health .bar-fill { background: var(--health); }
        .mana .bar-fill { background: var(--mana); }
        .xp .bar-fill { background: var(--xp); }

        .attributes { margin-top: 25px; }
        .attribute { display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #334155; }
        .attribute-name { display: flex; align-items: center; font-weight: bold; }
        .attribute-icon { margin-right: 10px; width: 24px; text-align: center; }

        .upgrade-btn { background: var(--accent); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .upgrade-btn:hover { background: var(--accent-dark); }
        .upgrade-btn:disabled { background: var(--locked); cursor: not-allowed; }

        .combat-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .stat-item { background: rgba(30, 41, 59, 0.7); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: var(--accent); }
        .stat-name { font-size: 0.85rem; color: var(--text-muted); }

        /* Inventory */
        .inventory-panel { background: var(--panel-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px; }

        .item-slot { background: rgba(30, 41, 59, 0.7); height: 70px; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px solid #334155; transition: all 0.3s; position: relative; cursor: pointer; }
        .item-slot.equipped { border-color: var(--accent); box-shadow: 0 0 10px rgba(59,130,246,0.5); }
        .item-slot.empty::before { content: "+"; font-size: 1.5rem; color: var(--text-muted); }

        .item-icon { font-size: 2rem; }
        .item-count { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }

        .sell-btn-inv { position: absolute; bottom: 4px; left: 4px; padding: 4px 6px; font-size: 0.7rem; background: var(--gold); border: none; border-radius: 4px; cursor: pointer; }

        /* Kobold-like UI for skills (images) */
        .skills-container { background: var(--panel-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .skills-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px; }
        .skill-card { background: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 8px; text-align: center; transition: all 0.3s ease; cursor: pointer; position: relative; }
        .skill-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .skill-card img { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; display: block; margin: 0 auto 8px; }
        .skill-name { font-weight: bold; margin-bottom: 5px; }
        .skill-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
        .skill-cost { font-size: 0.8rem; color: var(--mana); }
        .skill-upgrade { margin-top: 6px; padding: 6px 8px; font-size: 0.8rem; }

        /* Locations (Dungeon-like) */
        .location-panel { background: var(--panel-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .location-title { color: var(--accent); margin-bottom: 12px; border-bottom: 2px solid var(--accent); padding-bottom: 6px; }
        .location-desc { color: var(--text-muted); margin-bottom: 12px; line-height: 1.6; }

        .location-map { position: relative; width: 100%; height: 420px; background: rgba(30, 41, 59, 0.7); border-radius: 8px; margin-bottom: 20px; overflow:hidden; display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: 1fr; }
        .map-cell { border: 1px solid rgba(59,130,246,0.6); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; }
        .map-cell.wall { background: rgba(2,6,23,0.9); cursor: default; opacity: 0.5; }
        .map-cell.path { background: rgba(59,130,246,0.25); }
        .map-cell.player { background: rgba(16,185,129,0.5); }
        .map-cell.monster { background: rgba(239,68,68,0.5); }
        .locations-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }

        .location { background: rgba(30, 41, 59, 0.7); padding: 20px; border-radius: 8px; transition: all 0.3s ease; }
        .location:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .location-name { font-weight: bold; margin-bottom: 6px; color: var(--accent); }
        .location-type { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; display: inline-block; padding: 4px 8px; background: rgba(59,130,246,0.2); border-radius: 4px; }
        .location-level { display: inline-block; margin-left: 6px; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; background: rgba(99, 102, 241, 0.25); border: 1px solid rgba(99,102,241,0.8); color: #e2e8f0; }

        .monsters-list { margin: 8px 0; }

        /* Combat Screen */
        .combat-screen { background: var(--panel-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); text-align: center; }
        .combat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .combatant { display: flex; flex-direction: column; align-items: center; width: 45%; }
        .combat-avatar { font-size: 4rem; margin-bottom: 6px; }
        .combat-health { width: 100%; background: #334155; height: 20px; border-radius: 10px; overflow: hidden; }
        .combat-health-fill { height: 100%; background: var(--health); transition: width 0.3s; }
        .combat-skills { display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
        .combat-skill { font-size: 1.8rem; cursor: pointer; opacity: 0.9; transition: all 0.3s; }
        .combat-skill:hover { transform: scale(1.1); opacity: 1; }

        .combat-log { margin: 20px 0; padding: 15px; background: rgba(30,41,59,0.7); border-radius: 8px; max-height: 200px; overflow-y: auto; text-align: left; }

        .log-entry { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid #334155; }

        .combat-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .combat-btn { padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
        .combat-btn:hover { background: var(--accent-dark); }
        .combat-btn.attack { background: var(--danger); }
        .combat-btn.attack:hover { background: #dc2626; }
        /* Loot Screen */
        .loot-screen { background: var(--panel-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); text-align: center; }
        .loot-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; margin: 20px 0; }
        .loot-item { background: rgba(30,41,59,0.7); padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .loot-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .loot-quality-common { border-left: 4px solid #a0a0a0; }
        .loot-quality-uncommon { border-left: 4px solid #00ff00; }
        .loot-quality-rare { border-left: 4px solid #0070ff; }
        .loot-quality-epic { border-left: 4px solid #a335ee; }
        .loot-quality-legendary { border-left: 4px solid #ff8000; }

        /* Buffs */
        .buffs-container { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .buff { background: rgba(59,130,246,0.2); padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; }

        /* Start Button */
        .start-button { display: block; width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; margin-top: 30px; box-shadow: 0 4px 15px rgba(59,130,246,0.4); }
        .start-button:hover { background: var(--accent-dark); transform: translateY(-3px); }

        /* Level Up Notification */
        .level-up-notification { position: fixed; top: 20px; right: 20px; background: var(--accent); color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; display: flex; align-items: center; gap: 10px; transform: translateX(100%); transition: transform 0.5s ease; }
        .level-up-notification.show { transform: translateX(0); }

        /* Responsive */
        @media (max-width: 900px) {
            .character-creation { grid-template-columns: 1fr; }
            .character-sheet { grid-template-columns: 1fr; }
            .combat-stats { grid-template-columns: repeat(3, 1fr); }
            .skills-grid { grid-template-columns: repeat(2, 1fr); }
            .inventory-grid { grid-template-columns: repeat(4, 1fr); }
            .locations-grid { grid-template-columns: 1fr; }
            .shop-items, .blacksmith-items { grid-template-columns: repeat(2, 1fr); }
            .tabs { flex-wrap: wrap; }
            .tab-btn { flex: 1 0 50%; }
            header { flex-direction: column; gap: 15px; }
            .combat-actions { grid-template-columns: 1fr; }
            #header-avatar { width: 56px; height: 56px; }
        }

        @media (max-width: 600px) {
            .combat-stats { grid-template-columns: repeat(2, 1fr); }
            .skills-grid { grid-template-columns: 1fr; }
            .inventory-grid { grid-template-columns: repeat(3, 1fr); }
            .class-grid, .gender-grid { grid-template-columns: 1fr; }
            .shop-items, .blacksmith-items { grid-template-columns: 1fr; }
            .tab-btn { flex: 1 0 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="character-info">
                <div id="header-avatar">
                    <!-- динамическая картинка персонажа -->
                    <img id="header-avatar-img" src="https://dummyimage.com/96x96/3b82f6/ffffff.png&text=%F0%9F%94%AB" alt="Аватар" />
                </div>
                <div class="header-text">
                    <h1 id="header-name">Воин</h1>
                    <div id="header-level">Уровень 1</div>
                </div>
            </div>
            <div class="gold-display">
                <span>🪙</span>
                <span id="gold-amount">50</span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="creation">Создание</button>
            <button class="tab-btn" data-tab="stats">Характеристики</button>
            <button class="tab-btn" data-tab="skills">Умения</button>
            <button class="tab-btn" data-tab="tavern">Таверна</button>
            <button class="tab-btn" data-tab="location">Локации</button>
        </div>

        <div class="tab-content active" id="creation">
            <div class="character-creation">
                <div class="creation-panel">
                    <h2>Выбор класса</h2>
                    <div class="nickname-input">
                        <label for="nickname">Имя персонажа:</label>
                        <input type="text" id="nickname" placeholder="Введите имя">
                    </div>
                    <div class="class-grid">
                        <div class="class-option selected" data-class="warrior">
                            <div class="class-icon">⚔️</div>
                            <div class="class-name">Воин</div>
                            <div class="class-desc">Сильный боец ближнего боя</div>
                        </div>
                        <div class="class-option" data-class="mage">
                            <div class="class-icon">🧙</div>
                            <div class="class-name">Маг</div>
                            <div class="class-desc">Мощные заклинания и контроль</div>
                        </div>
                        <div class="class-option" data-class="archer">
                            <div class="class-icon">🏹</div>
                            <div class="class-name">Лучник</div>
                            <div class="class-desc">Точные выстрелы на расстоянии</div>
                        </div>
                        <div class="class-option" data-class="rogue">
                            <div class="class-icon">🗡️</div>
                            <div class="class-name">Разбойник</div>
                            <div class="class-desc">Скрытность и смертельные атаки</div>
                        </div>
                    </div>
                </div>

                <div class="creation-panel">
                    <h2>Выбор пола</h2>
                    <div class="gender-grid">
                        <div class="gender-option selected" data-gender="male">
                            <div class="class-icon">👨</div>
                            <div class="class-name">Мужской</div>
                        </div>
                        <div class="gender-option" data-gender="female">
                            <div class="class-icon">👩</div>
                            <div class="class-name">Женский</div>
                        </div>
                    </div>

                    <div class="character-preview">
                        <h3>Предпросмотр</h3>
                        <div class="preview-content">
                            <div id="character-avatar" aria-label="avatar"></div>
                            <div id="character-info">
                                <div id="character-name">Воин</div>
                                <div id="character-level">Уровень 1</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="stats">
            <div class="character-sheet">
                <div class="stats-panel">
                    <h2>Характеристики</h2>

                    <div class="character-header">
                        <div id="stats-avatar" aria-label="stats-avatar">
                            ⚔️
                            <div class="equipment-slots" id="weapon-slot"></div>
                            <div class="equipment-slots" id="armor-slot"></div>
                            <div class="equipment-slots" id="amulet-slot"></div>
                        </div>
                        <div>
                            <div id="stats-name">Воин</div>
                            <div id="stats-class">Уровень 1</div>
                        </div>
                    </div>

                    <div class="resource-bar health">
                        <div class="bar-label">
                            <span>Здоровье</span>
                            <span id="health-value">100 / 100</span>
                        </div>
                        <div class="bar">
                            <div class="bar-fill health" id="health-bar" style="width: 100%;"></div>
                        </div>
                    </div>

                    <div class="resource-bar mana">
                        <div class="bar-label">
                            <span>Мана</span>
                            <span id="mana-value">50 / 50</span>
                        </div>
                        <div class="bar">
                            <div class="bar-fill" id="mana-bar" style="width: 100%;"></div>
                        </div>
                    </div>

                    <div class="resource-bar xp">
                        <div class="bar-label">
                            <span>Опыт</span>
                            <span id="xp-value">0 / 100</span>
                        </div>
                        <div class="bar">
                            <div class="bar-fill" id="xp-bar" style="width: 0%;"></div>
                        </div>
                    </div>

                    <div class="attributes">
                        <div class="attribute">
                            <div class="attribute-name">
                                <div class="attribute-icon">💪</div>
                                <span>Сила</span>
                            </div>
                            <div class="attribute-value">
                                <span id="strength-value">5</span>
                                <button class="upgrade-btn" data-stat="strength">+</button>
                            </div>
                        </div>
                        <div class="attribute">
                            <div class="attribute-name">
                                <div class="attribute-icon">🏃</div>
                                <span>Ловкость</span>
                            </div>
                            <div class="attribute-value">
                                <span id="agility-value">5</span>
                                <button class="upgrade-btn" data-stat="agility">+</button>
                            </div>
                        </div>
                        <div class="attribute">
                            <div class="attribute-name">
                                <div class="attribute-icon">❤️</div>
                                <span>Живучесть</span>
                            </div>
                            <div class="attribute-value">
                                <span id="vitality-value">5</span>
                                <button class="upgrade-btn" data-stat="vitality">+</button>
                            </div>
                        </div>
                        <div class="attribute">
                            <div class="attribute-name">
                                <div class="attribute-icon">🧠</div>
                                <span>Интеллект</span>
                            </div>
                            <div class="attribute-value">
                                <span id="intellect-value">5</span>
                                <button class="upgrade-btn" data-stat="intellect">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="combat-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="attack-value">5-7</div>
                            <div class="stat-name">Атака</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="crit-value">5%</div>
                            <div class="stat-name">Крит. удар</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="speed-value">100%</div>
                            <div class="stat-name">Скорость</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="defense-value">5</div>
                            <div class="stat-name">Защита</div>
                        </div>
                    </div>

                    <div class="buffs-container" id="buffs-container">
                        <!-- Buffs will be populated here -->
                    </div>
                </div>

                <div class="inventory-panel">
                    <div class="inventory-header">
                        <h2>Рюкзак</h2>
                        <div id="inventory-weight">0/100</div>
                    </div>
                    <div class="inventory-grid" id="inventory">
                        <!-- слоты будут заполнены через JS -->
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="skills">
            <div class="skills-container">
                <h2>Умения класса</h2>
                <div class="skills-grid" id="skills-grid">
                    <!-- Skills will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="tavern">
            <div class="tavern-panel">
                <h2>Таверна "У Гнома"</h2>

                <div class="tavern-tabs">
                    <button class="tavern-tab active" data-tab="shop">Магазин</button>
                    <button class="tavern-tab" data-tab="blacksmith">Кузня</button>
                </div>

                <div class="tavern-content active" id="shop-content">
                    <div class="shop-items" id="shop-items">
                        <!-- Shop items will be populated by JavaScript -->
                    </div>
                </div>

                <div class="tavern-content" id="blacksmith-content">
                    <div class="blacksmith-tabs">
                        <button class="tavern-tab active" data-subtab="upgrade">Улучшение</button>
                        <button class="tavern-tab" data-subtab="dismantle">Разборка</button>
                    </div>

                    <div class="blacksmith-subcontent active" id="upgrade-content">
                        <div class="blacksmith-items" id="upgrade-items">
                            <!-- Upgrade items will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="blacksmith-subcontent" id="dismantle-content">
                        <div class="blacksmith-items" id="dismantle-items">
                            <!-- Dismantle items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="location">
            <div class="location-panel">
                <h2 class="location-title">Мир Эмона</h2>
                <p class="location-desc">
                    Исследуйте различные локации, сражайтесь с монстрами и находите сокровища.
                    Будьте осторожны - некоторые области могут быть опасны для неподготовленных путешественников.
                </p>

                <div class="location-map" id="location-map" aria-label="Карта подземелья">
                    <!-- Map will be populated by JavaScript -->
                </div>

                <div class="locations-grid" id="locations-grid">
                    <!-- Locations will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="combat">
            <div class="combat-screen">
                <div class="combat-header">
                    <div class="combatant">
                        <div class="combat-avatar" id="player-combat-avatar">⚔️</div>
                        <div class="combat-health">
                            <div class="combat-health-fill" id="player-health-bar"></div>
                        </div>
                        <div id="player-combat-health">100/100</div>
                        <div class="combat-skills" id="player-combat-skills" role="group" aria-label="Навыки персонажа">
                            <!-- Player skills will be populated here -->
                        </div>
                    </div>
                    <div>VS</div>
                    <div class="combatant">
                        <div class="combat-avatar" id="enemy-combat-avatar">🐺</div>
                        <div class="combat-health">
                            <div class="combat-health-fill" id="enemy-health-bar"></div>
                        </div>
                        <div id="enemy-combat-health">50/50</div>
                        <div class="combat-skills" id="enemy-combat-skills" aria-label="Навыки врага">
                            <!-- Enemy skills will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="combat-log" id="combat-log">
                    <div class="log-entry">Бой начинается!</div>
                </div>

                <div class="combat-actions" id="combat-actions">
                    <button class="combat-btn attack" id="attack-btn">Атака</button>
                    <button class="combat-btn" id="skill-btn">Умение</button>
                    <button class="combat-btn" id="item-btn">Предмет</button>
                    <button class="combat-btn" id="flee-btn">Бегство</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="loot">
            <div class="loot-screen">
                <h2>Добыча</h2>
                <p>Вы победили врага и нашли следующие предметы:</p>

                <div class="loot-items" id="loot-items">
                    <!-- Loot items will be populated here -->
                </div>

                <button class="combat-btn" id="take-loot-btn">Забрать все</button>
            </div>
        </div>

        <button class="start-button" id="start-button">Начать игру</button>
    </div>

    <div class="level-up-notification" id="level-up-notification" aria-live="polite" aria-atomic="true">
        <span>🎉 Поздравляем! Вы достигли уровня </span>
        <span id="level-number">2</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Game Data
            const classData = {
                warrior: {
                    name: "Воин",
                    icon: "⚔️",
                    avatarUrl: "https://dummyimage.com/128x128/3b82f6/ffffff.png&text=W",
                    stats: { health: 100, mana: 50, strength: 5, agility: 5, vitality: 5, intellect: 5 },
                    skills: [
                        { id: "s1", name: "Мощный удар", icon: "💥", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Наносит 150% урона", cost: "10 маны", level: 1, maxLevel: 5, type: "attack" },
                        { id: "s2", name: "Берсерк", icon: "⚡", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Увеличивает силу на 20%", cost: "15 маны", level: 0, maxLevel: 3, reqLevel: 2, type: "buff" },
                        { id: "s3", name: "Щитовая стена", icon: "🛡️", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Блокирует следующую атаку", cost: "20 маны", level: 0, maxLevel: 3, reqLevel: 3, type: "defense" },
                        { id: "s4", name: "Рывок", icon: "🏃", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Быстрое перемещение к цели", cost: "8 маны", level: 0, maxLevel: 3, reqLevel: 4, type: "movement" },
                        { id: "s5", name: "Размашистый удар", icon: "🌀", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Атака по области", cost: "25 маны", level: 0, maxLevel: 3, reqLevel: 5, type: "attack" },
                        { id: "s6", name: "Воинский клич", icon: "📢", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Увеличивает атаку всей группы", cost: "30 маны", level: 0, maxLevel: 2, reqLevel: 6, type: "buff" }
                    ]
                },
                mage: {
                    name: "Маг",
                    icon: "🧙",
                    avatarUrl: "https://dummyimage.com/128x128/8b5cf6/ffffff.png&text=M",
                    stats: { health: 80, mana: 100, strength: 5, agility: 5, vitality: 5, intellect: 5 },
                    skills: [
                        { id: "s1", name: "Огненный шар", icon: "🔥", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Наносит 12-14 урона", cost: "15 маны", level: 1, maxLevel: 5, type: "attack" },
                        { id: "s2", name: "Ледяная стрела", icon: "❄️", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Замедление цели", cost: "12 маны", level: 0, maxLevel: 3, reqLevel: 2, type: "debuff" },
                        { id: "s3", name: "Молния", icon: "⚡", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "16-18 урона", cost: "18 маны", level: 0, maxLevel: 3, reqLevel: 3, type: "attack" },
                        { id: "s4", name: "Магический щит", icon: "🛡️", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Поглощение урона", cost: "25 маны", level: 0, maxLevel: 3, reqLevel: 4, type: "defense" },
                        { id: "s5", name: "Телепорт", icon: "✨", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Короткое перемещение", cost: "20 маны", level: 0, maxLevel: 3, reqLevel: 5, type: "movement" },
                        { id: "s6", name: "Воскрешение", icon: "❤️", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Воскрешает союзника", cost: "50 маны", level: 0, maxLevel: 1, reqLevel: 10, type: "heal" }
                    ]
                },
                archer: {
                    name: "Лучник",
                    icon: "🏹",
                    avatarUrl: "https://dummyimage.com/128x128/10b981/ffffff.png&text=A",
                    stats: { health: 90, mana: 70, strength: 5, agility: 5, vitality: 5, intellect: 5 },
                    skills: [
                        { id: "s1", name: "Точный выстрел", icon: "🎯", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "100% шанс попадания", cost: "12 маны", level: 1, maxLevel: 5, type: "attack" },
                        { id: "s2", name: "Дождь стрел", icon: "🌧️", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Атака по области", cost: "20 маны", level: 0, maxLevel: 3, reqLevel: 2, type: "attack" },
                        { id: "s3", name: "Скрытность", icon: "👁️", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Невидимость на 10 сек", cost: "15 маны", level: 0, maxLevel: 3, reqLevel: 3, type: "buff" },
                        { id: "s4", name: "Ядовитая стрела", icon: "☠️", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Урон со временем", cost: "10 маны", level: 0, maxLevel: 3, reqLevel: 4, type: "debuff" },
                        { id: "s5", name: "Уклонение", icon: "🌀", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Увеличивает шанс уклонения", cost: "15 маны", level: 0, maxLevel: 3, reqLevel: 5, type: "buff" },
                        { id: "s6", name: "Смертельный выстрел", icon: "💀", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Критический урон цели", cost: "30 маны", level: 0, maxLevel: 2, reqLevel: 8, type: "attack" }
                    ]
                },
                rogue: {
                    name: "Разбойник",
                    icon: "🗡️",
                    avatarUrl: "https://dummyimage.com/128x128/ef4444/ffffff.png&text=R",
                    stats: { health: 85, mana: 60, strength: 5, agility: 5, vitality: 5, intellect: 5 },
                    skills: [
                        { id: "s1", name: "Смертельный удар", icon: "💀", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Критический удар в спину", cost: "15 маны", level: 1, maxLevel: 5, type: "attack" },
                        { id: "s2", name: "Отравление", icon: "🧪", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Урон со временем", cost: "8 маны", level: 0, maxLevel: 3, reqLevel: 2, type: "debuff" },
                        { id: "s3", name: "Уклонение", icon: "🌀", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Увеличивает шанс уклонения", cost: "12 маны", level: 0, maxLevel: 3, reqLevel: 3, type: "buff" },
                        { id: "s4", name: "Бросок ножей", icon: "🔪", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Атака несколькими целями", cost: "10 маны", level: 0, maxLevel: 3, reqLevel: 4, type: "attack" },
                        { id: "s5", name: "Незаметность", icon: "👻", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Становится невидимым", cost: "25 маны", level: 0, maxLevel: 2, reqLevel: 6, type: "buff" },
                        { id: "s6", name: "Фанатизм", icon: "⚡", image: "https://i.pinimg.com/736x/3d/e0/b0/3de0b0280809b0c9f11a6e79e4740a3a.jpg", desc: "Увеличивает скорость атаки", cost: "20 маны", level: 0, maxLevel: 2, reqLevel: 7, type: "buff" }
                    ]
                }
            };

            const itemsData = {
                weapons: [
                    { id: "w1", name: "Деревянный меч", icon: "⚔️", type: "weapon", price: 20, sellPrice: 5, attack: "3-5", reqLevel: 1, quality: "common" },
                    { id: "w2", name: "Стальной меч", icon: "⚔️", type: "weapon", price: 100, sellPrice: 25, attack: "8-12", reqLevel: 3, quality: "uncommon" },
                    { id: "w3", name: "Посох новичка", icon:"🔮", type: "weapon", price: 25, sellPrice: 6, attack: "2-4", magic: "5-7", reqLevel: 1, quality: "common" },
                    { id: "w4", name: "Длинный лук", icon: "🏹", type: "weapon", price: 80, sellPrice: 20, attack: "6-10", reqLevel: 2, quality: "uncommon" },
                    { id: "w5", name: "Кинжал разбойника", icon: "🗡️", type: "weapon", price: 70, sellPrice: 17, attack: "5-9", reqLevel: 2, quality: "uncommon" },
                    { id: "w6", name: "Легендарный клинок", icon: "⚔️", type: "weapon", price: 500, sellPrice: 125, attack: "20-30", reqLevel: 10, quality: "legendary" }
                ],
                armor: [
                    { id: "a1", name: "Кожаная броня", icon: "🛡️", type: "armor", price: 40, sellPrice: 10, defense: 5, reqLevel: 1, quality: "common" },
                    { id: "a2", name: "Кольчуга", icon: "🥋", type: "armor", price: 120, sellPrice: 30, defense: 12, reqLevel: 3, quality: "uncommon" },
                    { id: "a3", name: "Мантия мага", icon: "🧥", type: "armor", price: 60, sellPrice: 15, defense: 3, magic: 5, reqLevel: 2, quality: "uncommon" },
                    { id: "a4", name: "Доспех дракона", icon: "🐉", type: "armor", price: 400, sellPrice: 100, defense: 25, reqLevel: 8, quality: "epic" }
                ],
                amulets: [
                    { id: "am1", name: "Амулет здоровья", icon: "💎", type: "amulet", price: 60, sellPrice: 15, effect: { stat: "vitality", value: 2, duration: 0 }, quality: "uncommon" },
                    { id: "am2", name: "Амулет маны", icon: "🔮", type: "amulet", price: 70, sellPrice: 18, effect: { stat: "intellect", value: 2, duration: 0 }, quality: "uncommon" },
                    { id: "am3", name: "Амулет силы", icon: "🪄", type: "amulet", price: 120, sellPrice: 30, effect: { stat: "strength", value: 3, duration: 0 }, quality: "rare" }
                ],
                consumables: [
                    { id: "c1", name: "Зелье здоровья", icon: "🧪", type: "consumable", price: 15, sellPrice: 3, effect: { health: 30 } },
                    { id: "c2", name: "Зелье маны", icon: "🧪", type: "consumable", price: 20, sellPrice: 5, effect: { mana: 25 } },
                    { id: "c3", name: "Зелье силы", icon: "🧪", type: "consumable", price: 30, sellPrice: 7, effect: { buff: "strength", value: 2, duration: 300 } },
                    { id: "c4", name: "Зелье ловкости", icon: "🧪", type: "consumable", price: 30, sellPrice: 7, effect: { buff: "agility", value: 2, duration: 300 } }
                ],
                materials: [
                    { id: "m1", name: "Железная руда", icon: "⛰️", type: "material", price: 10, sellPrice: 2, quality: "common" },
                    { id: "m2", name: "Кожа", icon: "🐄", type: "material", price: 8, sellPrice: 1, quality: "common" },
                    { id: "m3", name: "Магический кристалл", icon: "💎", type: "material", price: 50, sellPrice: 12, quality: "uncommon" },
                    { id: "m4", name: "Руна усиления", icon: "🔰", type: "material", price: 100, sellPrice: 25, quality: "rare" }
                ]
            };

            const craftingData = [
                { id: "cr1", name: "Улучшение меча", icon: "⚔️", type: "upgrade", materials: [{ id: "m1", count: 3 }, { id: "m2", count: 2 }], result: "w2", price: 50 },
                { id: "cr2", name: "Улучшение брони", icon: "🛡️", type: "upgrade", materials: [{ id: "m1", count: 2 }, { id: "m2", count: 3 }], result: "a2", price: 80 },
                { id: "cr3", name: "Создание зелья силы", icon: "🧪", type: "craft", materials: [{ id: "m3", count: 1 }, { id: "m1", count: 2 }], result: "c3", price: 20 }
            ];

            const locationsData = [
                { id: "l1", name: "Лесная опушка", type: "Лес", desc: "Тихий лес на окраине города. Идеальное место для начинающих искателей приключений.", level: 1, monsters: [
                        { name: "Лесной волк", icon: "🐺", health: 30, maxHealth: 30, attack: "5-8", exp: 15, gold: "5-10", skills: ["Укус", "Рывок"] }
                    ], reqLevel: 1, loot: ["w1", "a1", "c1", "m1", "m2"] },
                { id: "l2", name: "Горные пещеры", type: "Горы", desc: "Скалистые пещеры, где обитают более опасные существа.", level: 2, monsters: [
                        { name: "Пещерный медведь", icon: "🐻", health: 60, maxHealth: 60, attack: "10-14", exp: 35, gold: "15-25", skills: ["Мощный удар", "Рев"] }
                    ], reqLevel: 2, loot: ["w2", "w4", "a2", "c2", "m1", "m2", "m3"] },
                { id: "l3", name: "Заброшенные руины", type: "Руины", desc: "Древние руины, хранящие множество секретов и опасностей.", level: 3, monsters: [
                        { name: "Скелет", icon: "💀", health: 50, maxHealth: 50, attack: "12-16", exp: 40, gold: "20-30", skills: ["Костяной удар", "Страх"] }
                    ], reqLevel: 3, loot: ["w3", "w5", "a3", "c3", "c4", "m2", "m3", "m4"] },
                { id: "l4", name: "Пещеры Лабиринта", type: "Подземелье", desc: "Загадочные коридоры с запутанными ходами.", level: 4, monsters: [
                        { name: "Страж Темноты", icon: "🗡️", health: 90, maxHealth: 90, attack: "14-20", exp: 60, gold: "25-40", skills: ["Тяжелый удар", "Удар тьмой"] }
                    ], reqLevel: 4, loot: ["w4", "w6", "a4", "m3", "m4"] },
                { id: "l5", name: "Пик подземного царства", type: "Подземелье", desc: "Глубокий уровень подземелья с сильными врагами.", level: 5, monsters: [
                        { name: "Гигантская Тьма", icon: "👾", health: 140, maxHealth: 140, attack: "20-28", exp: 120, gold: "60-100", skills: ["Разящий удар", "Темная волна"] }
                    ], reqLevel: 5, loot: ["w6", "a4", "m4"] }
            ];

            const buffsData = [
                { id: "b1", name: "Сила", icon: "💪", stat: "strength", value: 2, duration: 300 },
                { id: "b2", name: "Ловкость", icon: "🏃", stat: "agility", value: 2, duration: 300 },
                { id: "b3", name: "Живучесть", icon: "❤️", stat: "vitality", value: 2, duration: 300 },
                { id: "b4", name: "Интеллект", icon: "🧠", stat: "intellect", value: 2, duration: 300 },
                { id: "b5", name: "Защита", icon: "🛡️", stat: "defense", value: 5, duration: 300 },
                { id: "b6", name: "Критический удар", icon: "🎯", stat: "crit", value: 10, duration: 300 }
            ];

            // Game State
            let currentClass = 'warrior';
            let currentGender = 'male';
            let characterName = '';
            let characterLevel = 1;
            let characterXP = 0;
            let xpToNextLevel = 100;
            let statPoints = 0;
            let skillPoints = 0;
            let gold = 50;
            let characterCreated = false;
            let inventory = [];
            let equipped = {
                weapon: null,
                armor: null,
                amulet: null
            };
            let currentLocation = null;
            let currentEnemy = null;
            let combatActive = false;
            let playerBuffs = [];
            let currentLoot = [];

            // DOM Elements
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const classOptions = document.querySelectorAll('.class-option');
            const genderOptions = document.querySelectorAll('.gender-option');
            const nicknameInput = document.getElementById('nickname');
            const startButton = document.getElementById('start-button');
            const headerAvatarImg = document.getElementById('header-avatar-img');
            const characterAvatar = document.getElementById('character-avatar');
            const characterNameDisplay = document.getElementById('character-name');
            const headerName = document.getElementById('header-name');
            const headerLevel = document.getElementById('header-level');
            const goldAmount = document.getElementById('gold-amount');
            const statsAvatar = document.getElementById('stats-avatar');
            const weaponSlot = document.getElementById('weapon-slot');
            const armorSlot = document.getElementById('armor-slot');
            const amuletSlot = document.getElementById('amulet-slot');
            const statsName = document.getElementById('stats-name');
            const statsClass = document.getElementById('stats-class');
            const healthValue = document.getElementById('health-value');
            const manaValue = document.getElementById('mana-value');
            const xpValue = document.getElementById('xp-value');
            const healthBar = document.getElementById('health-bar');
            const manaBar = document.getElementById('mana-bar');
            const xpBar = document.getElementById('xp-bar');
            const strengthValue = document.getElementById('strength-value');
            const agilityValue = document.getElementById('agility-value');
            const vitalityValue = document.getElementById('vitality-value');
            const intellectValue = document.getElementById('intellect-value');
            const skillsGrid = document.getElementById('skills-grid');
            const inventoryGrid = document.getElementById('inventory');
            const shopItems = document.getElementById('shop-items');
            const locationsGrid = document.getElementById('locations-grid');
            const locationMap = document.getElementById('location-map');
            const upgradeButtons = document.querySelectorAll('.upgrade-btn');
            const levelUpNotification = document.getElementById('level-up-notification');
            const tavernTabs = document.querySelectorAll('.tavern-tab');
            const tavernContents = document.querySelectorAll('.tavern-content');
            const buffsContainer = document.getElementById('buffs-container');

            // Initialize
            initTabs();
            initCharacterCreation();
            initUpgradeButtons();
            initTavernTabs();
            updateCharacterPreview();
            renderSkills(currentClass);
            renderShop();
            renderBlacksmith();
            renderLocations();

            // Tab System
            function initTabs() {
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-tab');

                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');

                        tabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === tabId) {
                                content.classList.add('active');
                            }
                        });
                    });
                });
            }

            // Tavern Tab System
            function initTavernTabs() {
                tavernTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-tab');

                        tavernTabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');

                        tavernContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === `${tabId}-content`) {
                                content.classList.add('active');
                            }
                        });
                    });
                });
            }

            // Character Creation
            function initCharacterCreation() {
                classOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        if (characterCreated) return;

                        classOptions.forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        currentClass = this.getAttribute('data-class');
                        updateCharacterPreview();
                        renderSkills(currentClass);
                    });
                });

                genderOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        if (characterCreated) return;

                        genderOptions.forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        currentGender = this.getAttribute('data-gender');
                        updateCharacterPreview();
                    });
                });

                nicknameInput.addEventListener('input', function() {
                    characterName = this.value;
                    updateCharacterPreview();
                });
            }

            // Upgrade Buttons
            function initUpgradeButtons() {
                upgradeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        if (statPoints <= 0) return;

                        const stat = this.getAttribute('data-stat');
                        upgradeStat(stat);
                    });
                });
            }

            // Upgrade Stat
            function upgradeStat(stat) {
                if (statPoints <= 0) return;

                const currentValue = parseInt(document.getElementById(`${stat}-value`).textContent);

                document.getElementById(`${stat}-value`).textContent = currentValue + 1;
                statPoints--;

                updateDerivedStats();
                if (statPoints <= 0) {
                    upgradeButtons.forEach(btn => btn.disabled = true);
                }
            }

            // Update Derived Stats
            function updateDerivedStats() {
                const strength = parseInt(strengthValue.textContent);
                const agility = parseInt(agilityValue.textContent);
                const vitality = parseInt(vitalityValue.textContent);
                const intellect = parseInt(intellectValue.textContent);

                let strengthBonus = 0, agilityBonus = 0, vitalityBonus = 0, intellectBonus = 0, defenseBonus = 0, critBonus = 0;
                playerBuffs.forEach(buff => {
                    if (buff.stat === 'strength') strengthBonus += buff.value;
                    if (buff.stat === 'agility') agilityBonus += buff.value;
                    if (buff.stat === 'vitality') vitalityBonus += buff.value;
                    if (buff.stat === 'intellect') intellectBonus += buff.value;
                    if (buff.stat === 'defense') defenseBonus += buff.value;
                    if (buff.stat === 'crit') critBonus += buff.value;
                });

                const classInfo = classData[currentClass];
                const baseHealth = classInfo.stats.health;
                const health = baseHealth + ((vitality + vitalityBonus) * 5);
                healthValue.textContent = `${health} / ${health}`;
                healthBar.style.width = '100%';

                const baseMana = classInfo.stats.mana;
                const mana = baseMana + ((intellect + intellectBonus) * 3);
                manaValue.textContent = `${mana} / ${mana}`;
                manaBar.style.width = '100%';

                let attackMin = Math.floor((strength + strengthBonus) * 0.8 + (agility + agilityBonus) * 0.2);
                let attackMax = Math.floor((strength + strengthBonus) * 1.2 + (agility + agilityBonus) * 0.3);

                if (equipped.weapon) {
                    const weapon = itemsData.weapons.find(w => w.id === equipped.weapon);
                    if (weapon) {
                        const weaponAttack = weapon.attack.split('-').map(Number);
                        attackMin += weaponAttack[0];
                        attackMax += weaponAttack[1];
                    }
                }

                document.getElementById('attack-value').textContent = `${attackMin}-${attackMax}`;

                let defense = Math.floor((vitality + vitalityBonus) * 1.2) + defenseBonus;
                if (equipped.armor) {
                    const armor = itemsData.armor.find(a => a.id === equipped.armor);
                    if (armor) defense += armor.defense;
                }
                if (equipped.amulet) {
                    const am = itemsData.amulets.find(a => a.id === equipped.amulet);
                    if (am && am.effect && am.effect.stat === 'defense') defense += am.effect.value || 0;
                }
                document.getElementById('defense-value').textContent = defense;

                document.getElementById('crit-value').textContent = `${Math.min(5 + (agility + agilityBonus) * 0.5 + critBonus, 50).toFixed(1)}%`;
            }

            // Update Character Preview
            function updateCharacterPreview() {
                const classInfo = classData[currentClass];
                const genderIcon = currentGender === 'male' ? '👨' : '👩';

                characterAvatar.innerHTML = `<span>${genderIcon}</span> <img src="${classInfo.avatarUrl}" alt="avatar" style="width:64px;height:64px;border-radius:8px;vertical-align:middle;margin-left:6px;">`;
                headerAvatarImg.src = classInfo.avatarUrl;

                // Update name
                const displayName = characterName || classInfo.name;
                characterNameDisplay.textContent = displayName;
                headerName.textContent = displayName;
                statsName.textContent = displayName;

                // Update level
                characterLevelDisplay = document.getElementById('character-level');
                characterLevelDisplay.textContent = `Уровень ${characterLevel}`;
                headerLevel.textContent = `Уровень ${characterLevel}`;
                statsClass.textContent = `${classInfo.name} - Уровень ${characterLevel}`;

                // Update stats
                const health = classInfo.stats.health + (parseInt(vitalityValue.textContent) - 5) * 5;
                const mana = classInfo.stats.mana + (parseInt(intellectValue.textContent) - 5) * 3;

                healthValue.textContent = `${health} / ${health}`;
                manaValue.textContent = `${mana} / ${mana}`;
                xpValue.textContent = `${characterXP} / ${xpToNextLevel}`;

                healthBar.style.width = '100%';
                manaBar.style.width = '100%';
                xpBar.style.width = `${(characterXP / xpToNextLevel) * 100}%`;

                goldAmount.textContent = gold;

                updateEquipmentSlots();
                updateDerivedStats();
                renderBuffs();
            }

            // Update Equipment Slots
            function updateEquipmentSlots() {
                if (equipped.weapon) {
                    const weapon = itemsData.weapons.find(w => w.id === equipped.weapon);
                    weaponSlot.textContent = weapon ? weapon.icon : '';
                } else {
                    weaponSlot.textContent = '';
                }

                if (equipped.armor) {
                    const armor = itemsData.armor.find(a => a.id === equipped.armor);
                    armorSlot.textContent = armor ? armor.icon : '';
                } else {
                    armorSlot.textContent = '';
                }

                if (equipped.amulet) {
                    const amulet = itemsData.amulets.find(a => a.id === equipped.amulet);
                    amuletSlot.textContent = amulet ? amulet.icon : '';
                } else {
                    amuletSlot.textContent = '';
                }
            }

            // Render Buffs
            function renderBuffs() {
                buffsContainer.innerHTML = '';
                playerBuffs.forEach(buff => {
                    const buffElement = document.createElement('div');
                    buffElement.className = 'buff';
                    buffElement.innerHTML = `${buff.icon} ${buff.name}: +${buff.value} ${getStatName(buff.stat)}`;
                    buffsContainer.appendChild(buffElement);
                });
            }

            // Get Stat Name
            function getStatName(stat) {
                const statNames = {
                    'strength': 'Сила',
                    'agility': 'Ловкость',
                    'vitality': 'Живучесть',
                    'intellect': 'Интеллект',
                    'defense': 'Защита',
                    'crit': 'Крит'
                };
                return statNames[stat] || stat;
            }

            // Render Skills
            function renderSkills(className) {
                skillsGrid.innerHTML = '';
                const skills = classData[className].skills;

                skills.forEach(skill => {
                    const skillCard = document.createElement('div');
                    skillCard.className = 'skill-card';
                    skillCard.style.display = 'inline-block';
                    skillCard.innerHTML = `
                        <img src="${skill.image}" alt="${skill.name}">
                        <div class="skill-name" title="${skill.name}">${skill.name}</div>
                        <div class="skill-desc">${skill.desc}</div>
                        <div class="skill-cost">${skill.cost}</div>
                        ${skill.level > 0 ? `<div class="skill-level" style="font-size:0.8rem;">Уровень ${skill.level}/${skill.maxLevel}</div>` : ''}
                        <button class="skill-upgrade" data-index="${skills.indexOf(skill)}" ${skill.level >= skill.maxLevel || skillPoints <= 0 ? 'disabled' : ''}>
                            ${skill.level === 0 ? 'Изучить' : 'Улучшить'}
                        </button>
                    `;

                    // Upgrade handler
                    skillCard.querySelector('.skill-upgrade')?.addEventListener('click', function() {
                        if (skillPoints <= 0) return;
                        const idx = parseInt(this.getAttribute('data-index'));
                        const sk = classData[className].skills[idx];
                        if (!sk) return;
                        if (sk.level >= sk.maxLevel) return;
                        sk.level++;
                        skillPoints--;
                        renderSkills(currentClass);
                        updateDerivedStats();
                    });

                    // Click to use (activate first learned skill)
                    skillCard.addEventListener('click', () => {
                        // Use skill if learned (level > 0) - for brevity, call a simple log
                        const idx = skills.indexOf(skill);
                        const sk = skills[idx];
                        if (sk && sk.level > 0) {
                            useSkill(sk);
                        }
                    });

                    skillsGrid.appendChild(skillCard);
                });
            }

            // Render Shop
            function renderShop() {
                shopItems.innerHTML = '';

                // Render weapons
                itemsData.weapons.forEach(weapon => {
                    if (weapon.reqLevel > characterLevel) return;

                    const shopItem = document.createElement('div');
                    shopItem.className = 'shop-item';
                    shopItem.innerHTML = `
                        <div class="item-icon">${weapon.icon}</div>
                        <div class="item-name">${weapon.name}</div>
                        <div class="item-desc">Атака: ${weapon.attack}${weapon.magic ? `<br>Магия: ${weapon.magic}` : ''}</div>
                        <div class="item-price">${weapon.price} золота</div>
                        <button class="buy-btn" data-id="${weapon.id}" data-type="weapon">Купить</button>
                        <button class="sell-btn" data-id="${weapon.id}" data-type="weapon" disabled>Продать</button>
                    `;

                    shopItems.appendChild(shopItem);
                });

                // Armor
                itemsData.armor.forEach(armor => {
                    if (armor.reqLevel > characterLevel) return;

                    const shopItem = document.createElement('div');
                    shopItem.className = 'shop-item';
                    shopItem.innerHTML = `
                        <div class="item-icon">${armor.icon}</div>
                        <div class="item-name">${armor.name}</div>
                        <div class="item-desc">Защита: ${armor.defense}${armor.magic ? `<br>Магия: +${armor.magic}` : ''}</div>
                        <div class="item-price">${armor.price} золота</div>
                        <button class="buy-btn" data-id="${armor.id}" data-type="armor">Купить</button>
                        <button class="sell-btn" data-id="${armor.id}" data-type="armor" disabled>Продать</button>
                    `;
                    shopItems.appendChild(shopItem);
                });

                // Amulets
                itemsData.amulets.forEach(amulet => {
                    const shopItem = document.createElement('div');
                    shopItem.className = 'shop-item';
                    shopItem.innerHTML = `
                        <div class="item-icon">${amulet.icon}</div>
                        <div class="item-name">${amulet.name}</div>
                        <div class="item-desc">Эффект: +${amulet.effect.value} к ${amulet.effect.stat}</div>
                        <div class="item-price">${amulet.price} золота</div>
                        <button class="buy-btn" data-id="${amulet.id}" data-type="amulet">Купить</button>
                        <button class="sell-btn" data-id="${amulet.id}" data-type="amulet" disabled>Продать</button>
                    `;
                    shopItems.appendChild(shopItem);
                });

                // Consumables
                itemsData.consumables.forEach(consumable => {
                    const shopItem = document.createElement('div');
                    shopItem.className = 'shop-item';
                    shopItem.innerHTML = `
                        <div class="item-icon">${consumable.icon}</div>
                        <div class="item-name">${consumable.name}</div>
                        <div class="item-desc">Восстанавливает: ${consumable.effect.health ? 'Здоровье' : 'Мана'}</div>
                        <div class="item-price">${consumable.price} золота</div>
                        <button class="buy-btn" data-id="${consumable.id}" data-type="consumable">Купить</button>
                        <button class="sell-btn" data-id="${consumable.id}" data-type="consumable" disabled>Продать</button>
                    `;
                    shopItems.appendChild(shopItem);
                });

                // Materials
                itemsData.materials.forEach(material => {
                    const shopItem = document.createElement('div');
                    shopItem.className = 'shop-item';
                    shopItem.innerHTML = `
                        <div class="item-icon">${material.icon}</div>
                        <div class="item-name">${material.name}</div>
                        <div class="item-desc">Материал для крафта</div>
                        <div class="item-price">${material.price} золота</div>
                        <button class="buy-btn" data-id="${material.id}" data-type="material">Купить</button>
                        <button class="sell-btn" data-id="${material.id}" data-type="material" disabled>Продать</button>
                    `;
                    shopItems.appendChild(shopItem);
                });

                // Add event listeners to buy buttons
                document.querySelectorAll('.buy-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const type = this.getAttribute('data-type');
                        buyItem(id, type);
                    });
                });

                // Add event listeners to sell buttons
                document.querySelectorAll('.sell-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const type = this.getAttribute('data-type');
                        sellItem(id, type);
                    });
                });
            }

            // Render Blacksmith
            function renderBlacksmith() {
                // Простейшая реализация кузни: показываем список апгрейдов и разборка
                const upgradeContainer = document.getElementById('upgrade-items');
                const dismantleContainer = document.getElementById('dismantle-items');
                upgradeContainer.innerHTML = '';
                dismantleContainer.innerHTML = '';

                craftingData.forEach(item => {
                    if (item.type === 'upgrade') {
                        const node = document.createElement('div');
                        node.className = 'shop-item';
                        const reqs = item.materials.map(m => {
                            const mat = itemsData.materials.find(x => x.id === m.id);
                            return `${m.count}x ${mat ? mat.name : m.id}`;
                        }).join(', ');
                        node.innerHTML = `
                            <div class="item-icon">${item.icon}</div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">Материалы: ${reqs}</div>
                            <div class="item-price">Цена: ${item.price} золота</div>
                            <button class="upgrade-btn" data-id="${item.id}">Улучшить</button>
                        `;
                        upgradeContainer.appendChild(node);
                    } else if (item.type === 'craft') {
                        const node = document.createElement('div');
                        node.className = 'shop-item';
                        const reqs = item.materials.map(m => {
                            const mat = itemsData.materials.find(x => x.id === m.id);
                            return `${m.count}x ${mat ? mat.name : m.id}`;
                        }).join(', ');
                        node.innerHTML = `
                            <div class="item-icon">${item.icon}</div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">Материалы: ${reqs}</div>
                            <div class="item-price">Цена: ${item.price} золота</div>
                            <button class="craft-btn" data-id="${item.id}">Сделать</button>
                        `;
                        dismantleContainer.appendChild(node); // reuse dismantle area for crafts
                    }
                });

                // Bind events
                document.querySelectorAll('.upgrade-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const cr = craftingData.find(c => c.id === id);
                        if (!cr) return;
                        // Check materials in inventory
                        let ok = true;
                        const needed = cr.materials;
                        needed.forEach(n => {
                            const inInv = inventory.find(it => it.id === n.id);
                            const qty = inInv ? inInv.qty : 0;
                            if (qty < n.count) ok = false;
                        });
                        if (!ok) {
                            alert('Недостаточно материалов для апгрейда.');
                            return;
                        }
                        // Consume materials
                        needed.forEach(n => {
                            let rem = n.count;
                            for (let i = 0; i < inventory.length && rem > 0; i++) {
                                if (inventory[i].id === n.id) {
                                    const take = Math.min(inventory[i].qty, rem);
                                    inventory[i].qty -= take;
                                    rem -= take;
                                    if (inventory[i].qty <= 0) inventory.splice(i, 1);
                                    i--;
                                }
                            }
                        });
                        // Add/upgrade result item
                        const resultId = cr.result;
                        // Try to fetch item by id from lists
                        let newItem = itemsData.weapons.find(w => w.id === resultId)
                                      || itemsData.armor.find(a => a.id === resultId)
                                      || itemsData.consumables.find(c => c.id === resultId)
                                      || itemsData.materials.find(m => m.id === resultId);
                        if (newItem) {
                            addToInventory({ ...newItem, qty: 1 });
                            alert(`Получено: ${newItem.name}`);
                        } else {
                            alert('Апгрейд прошёл, но нет подходящего предмета для примера.');
                        }
                        renderInventory();
                        renderShop();
                    });
                });

                document.querySelectorAll('.craft-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const cr = craftingData.find(c => c.id === id);
                        if (!cr) return;
                        // Consume materials
                        let ok = true;
                        cr.materials.forEach(n => {
                            const invItem = inventory.find(it => it.id === n.id);
                            const qty = invItem ? invItem.qty : 0;
                            if (qty < n.count) ok = false;
                        });
                        if (!ok) {
                            alert('Недостаточно материалов для крафта.');
                            return;
                        }
                        cr.materials.forEach(n => {
                            let needed = n.count;
                            for (let i = 0; i < inventory.length && needed > 0; i++) {
                                if (inventory[i].id === n.id) {
                                    const take = Math.min(inventory[i].qty, needed);
                                    inventory[i].qty -= take;
                                    needed -= take;
                                    if (inventory[i].qty <= 0) inventory.splice(i, 1);
                                    i--;
                                }
                            }
                        });
                        // Result item
                        const result = cr.result;
                        let itemObj = null;
                        // Try to locate object by id in any list
                        itemObj = itemsData.weapons.find(w => w.id === result) || itemsData.armor.find(a => a.id === result) || itemsData.consumables.find(c => c.id === result) || itemsData.materials.find(m => m.id === result);
                        if (itemObj) {
                            addToInventory({ ...itemObj, qty: 1 });
                            alert(`Создан: ${itemObj.name}`);
                        }
                        renderInventory();
                        renderShop();
                    });
                });
            }

            // Render Locations
            function renderLocations() {
                locationsGrid.innerHTML = '';

                // Группировка по уровням
                const levels = [1,2,3,4,5];
                levels.forEach(level => {
                    const levelSection = document.createElement('div');
                    levelSection.style.width = '100%';
                    levelSection.innerHTML = `<div class="location-header" style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                                                <span style="font-weight:bold;color:var(--accent);">Уровень ${level}</span>
                                                <span class="location-level">уровень локации</span>
                                              </div>`;

                    const grid = document.createElement('div');
                    grid.className = 'locations-grid';
                    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(260px, 1fr))';
                    locationsGrid.appendChild(grid);
                    // add matching locations
                    locationsData.filter(l => l.level === level).forEach(location => {
                        const locationCard = document.createElement('div');
                        locationCard.className = 'location';
                        locationCard.innerHTML = `
                            <div class="location-name">${location.name}</div>
                            <div class="location-type">${location.type}</div>
                            <div class="location-desc">${location.desc}</div>
                            <div class="monsters-list">
                                ${location.monsters.map(mon => `<div class="monster"><span>${mon.icon} ${mon.name}</span><span>Ур.${location.level}</span></div>`).join('')}
                            </div>
                            <span class="location-level" style="margin-top:6px;">Уровень ${location.level}</span>
                            <button class="location-btn" data-id="${location.id}" style="width:100%; margin-top:6px;">Отправиться</button>
                        `;
                        grid.appendChild(locationCard);
                    });
                });

                // Add event listeners
                document.querySelectorAll('.location-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        enterLocation(id);
                    });
                });
            }

            // Enter Location
            function enterLocation(id) {
                currentLocation = locationsData.find(l => l.id === id);
                if (!currentLocation) return;

                if (characterLevel < currentLocation.reqLevel) {
                    alert(`Для посещения этой локации требуется уровень ${currentLocation.reqLevel}!`);
                    return;
                }

                renderLocationMap();
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                document.querySelector('.tab-btn[data-tab="location"]').classList.add('active');
                document.getElementById('location').classList.add('active');
            }

            // Render Location Map (удлиненная карта подземелья)
            function renderLocationMap() {
                locationMap.innerHTML = '';
                // 7x7 dungeon-like grid
                const size = 7;
                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                        const cell = document.createElement('div');
                        // Костыльный dungeon-эффект: стена/путь
                        const nx = x, ny = y;
                        const dist = Math.abs(nx - Math.floor(size/2)) + Math.abs(ny - Math.floor(size/2));
                        const isCenter = nx === Math.floor(size/2) && ny === Math.floor(size/2);
                        if (dist > Math.floor(size/2) || isCenter && Math.random() > 0.6) {
                            cell.className = 'map-cell wall';
                            cell.textContent = '';
                        } else {
                            const isMonsterHere = Math.random() < 0.25;
                            if (isMonsterHere && currentLocation) {
                                const monster = currentLocation.monsters[Math.floor(Math.random() * currentLocation.monsters.length)];
                                cell.className = 'map-cell monster';
                                cell.textContent = monster.icon;
                                cell.setAttribute('data-monster', JSON.stringify(monster));
                                cell.setAttribute('data-monster-name', monster.name);
                            } else {
                                cell.className = 'map-cell path';
                                cell.textContent = '';
                            }
                        }
                        // Place player near start
                        if (x === 0 && y === 0) {
                            cell.classList.add('player');
                            cell.textContent = headerAvatarImg.alt || '';
                        }
                        cell.style.gridColumnStart = x + 1;
                        cell.style.gridRowStart = y + 1;
                        cell.addEventListener('click', handleMapCellClick);
                        locationMap.appendChild(cell);
                    }
                }
            }

            // Handle Map Cell Click
            function handleMapCellClick(event) {
                const cell = event.currentTarget;
                if (cell.classList.contains('monster')) {
                    const monsterData = JSON.parse(cell.getAttribute('data-monster'));
                    startCombat(monsterData);
                } else if (cell.classList.contains('path') || cell.classList.contains('player')) {
                    // Move player to this cell (visual only)
                    document.querySelectorAll('.map-cell.player').forEach(c => c.classList.remove('player'));
                    cell.classList.add('player');
                    cell.textContent = headerAvatarImg.alt || '';
                    // Chance to find an item
                    if (Math.random() < 0.1) {
                        const randomItem = itemsData.consumables[Math.floor(Math.random() * itemsData.consumables.length)];
                        addToInventory(randomItem);
                        alert(`Вы нашли: ${randomItem.name}`);
                        renderInventory();
                    }
                }
            }

            // Start Combat
            function startCombat(monster) {
                currentEnemy = { ...monster };
                currentEnemy.maxHealth = monster.maxHealth || monster.health;
                combatActive = true;

                document.getElementById('player-combat-avatar').innerHTML = headerAvatarImg.alt ? headerAvatarImg.alt : '⚔️';
                document.getElementById('enemy-combat-avatar').textContent = currentEnemy.icon || '🐺';

                const playerHealth = healthValue.textContent.split(' / ')[0];
                const playerMaxHealth = healthValue.textContent.split(' / ')[1] || healthValue.textContent.split(' / ')[0];
                document.getElementById('player-combat-health').textContent = `${playerHealth} / ${playerMaxHealth}`;
                document.getElementById('player-health-bar').style.width = '100%';

                document.getElementById('enemy-combat-health').textContent = `${currentEnemy.health} / ${currentEnemy.maxHealth}`;
                document.getElementById('enemy-health-bar').style.width = '100%';

                document.getElementById('combat-log').innerHTML = `<div class="log-entry">Вы встретили ${currentEnemy.name}!</div>`;

                renderCombatSkills();
                renderEnemySkills();

                document.getElementById('attack-btn').addEventListener('click', playerAttack);
                document.getElementById('flee-btn').addEventListener('click', attemptFlee);

                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                document.querySelector('.tab-btn[data-tab="combat"]').classList.add('active');
                document.getElementById('combat').classList.add('active');
            }

            // Render Combat Skills
            function renderCombatSkills() {
                const skillsContainer = document.getElementById('player-combat-skills');
                skillsContainer.innerHTML = '';

                const skills = classData[currentClass].skills.filter(skill => skill.level > 0);
                skills.forEach((skill, idx) => {
                    const skillEl = document.createElement('div');
                    skillEl.className = 'combat-skill';
                    skillEl.innerHTML = `<img src="${skill.image}" alt="${skill.name}" style="width:48px;height:48px;border-radius:6px;"/><div>${skill.icon}</div>`;

                    skillEl.title = `${skill.name}: ${skill.desc}`;
                    skillEl.style.display = 'inline-block';
                    skillEl.style.cursor = 'pointer';
                    skillEl.addEventListener('click', () => useSkill(skill));
                    skillsContainer.appendChild(skillEl);
                });
            }

            // Render Enemy Skills
            function renderEnemySkills() {
                const skillsContainer = document.getElementById('enemy-combat-skills');
                skillsContainer.innerHTML = '';
                if (currentEnemy.skills) {
                    currentEnemy.skills.forEach(skill => {
                        const skillEl = document.createElement('div');
                        skillEl.className = 'combat-skill';
                        skillEl.textContent = '⚡';
                        skillEl.title = skill;
                        skillsContainer.appendChild(skillEl);
                    });
                }
            }

            // Use Skill
            function useSkill(skill) {
                if (!combatActive) return;
                const log = document.getElementById('combat-log');
                log.innerHTML += `<div class="log-entry">Вы используете ${skill.name}!</div>`;
                log.scrollTop = log.scrollHeight;
                // Простой эффект: наносим небольшой урон врагу
                const dmg = Math.floor(Math.random() * 6) + 4;
                currentEnemy.health -= dmg;
                if (currentEnemy.health < 0) currentEnemy.health = 0;
                document.getElementById('enemy-combat-health').textContent = `${currentEnemy.health}/${currentEnemy.maxHealth}`;
                document.getElementById('enemy-health-bar').style.width = `${(currentEnemy.health / currentEnemy.maxHealth) * 100}%`;
                if (currentEnemy.health <= 0) {
                    enemyDefeated();
                    return;
                }
                setTimeout(enemyAttack, 800);
            }

            // Keybinds: 1-6 для навыков
            window.addEventListener('keydown', (e) => {
                if (!combatActive) return;
                const k = parseInt(e.key, 10);
                if (!isNaN(k) && k >= 1 && k <= 6) {
                    const sk = classData[currentClass].skills[k-1];
                    if (sk && sk.level > 0) {
                        useSkill(sk);
                    }
                }
            });

            // Player Attack
            function playerAttack() {
                if (!combatActive) return;

                const attackBtn = document.getElementById('attack-btn');
                attackBtn.disabled = true;

                const attackValue = document.getElementById('attack-value').textContent;
                const [minAttack, maxAttack] = attackValue.split('-').map(Number);
                const damage = Math.floor(Math.random() * (maxAttack - minAttack + 1)) + minAttack;

                currentEnemy.health -= damage;
                const combatLog = document.getElementById('combat-log');
                combatLog.innerHTML += `<div class="log-entry">Вы нанесли ${damage} урона ${currentEnemy.name}!</div>`;
                combatLog.scrollTop = combatLog.scrollHeight;

                const enemyHealthPercent = (currentEnemy.health / currentEnemy.maxHealth) * 100;
                document.getElementById('enemy-health-bar').style.width = `${enemyHealthPercent}%`;
                document.getElementById('enemy-combat-health').textContent = `${currentEnemy.health}/${currentEnemy.maxHealth}`;

                if (currentEnemy.health <= 0) {
                    enemyDefeated();
                    attackBtn.disabled = false;
                    return;
                }

                setTimeout(enemyAttack, 1000);
            }

            // Enemy Attack
            function enemyAttack() {
                if (!combatActive) return;

                const minMax = currentEnemy.attack ? currentEnemy.attack.split('-').map(Number) : [2, 6];
                const damage = Math.floor(Math.random() * (minMax[1] - minMax[0] + 1)) + minMax[0];

                // Player health
                const currentHealth = parseInt(healthValue.textContent.split(' / ')[0]);
                const maxHealth = parseInt(healthValue.textContent.split(' / ')[1]);
                let newHealth = currentHealth - damage;
                if (newHealth < 0) newHealth = 0;

                healthValue.textContent = `${newHealth} / ${maxHealth}`;
                const healthPercent = (newHealth / maxHealth) * 100;
                healthBar.style.width = `${healthPercent}%`;
                document.getElementById('player-health-bar').style.width = `${healthPercent}%`;
                document.getElementById('player-combat-health').textContent = `${newHealth}/${maxHealth}`;

                const combatLog = document.getElementById('combat-log');
                combatLog.innerHTML += `<div class="log-entry">${currentEnemy.name} нанес вам ${damage} урона!</div>`;
                combatLog.scrollTop = combatLog.scrollHeight;

                if (newHealth <= 0) {
                    playerDefeated();
                    return;
                }

                document.getElementById('attack-btn').disabled = false;
            }

            // Enemy Defeated
            function enemyDefeated() {
                combatActive = false;
                const expGain = currentEnemy.exp || 10;
                const minGold = parseInt(currentEnemy.gold?.split('-')[0] || '5');
                const maxGold = parseInt(currentEnemy.gold?.split('-')[1] || '15');
                const goldGain = Math.floor(Math.random() * (maxGold - minGold + 1)) + minGold;

                addXP(expGain);
                gold += goldGain;
                generateLoot();

                const combatLog = document.getElementById('combat-log');
                combatLog.innerHTML += `<div class="log-entry">Вы победили ${currentEnemy.name} и получили ${expGain} опыта и ${goldGain} золота!</div>`;
                combatLog.scrollTop = combatLog.scrollHeight;

                showLootScreen();
            }

            // Generate Loot
            function generateLoot() {
                currentLoot = [];
                currentLoot.push({ type: 'gold', amount: Math.floor(Math.random() * 10) + 5 });
                if (currentLocation) {
                    currentLocation.loot.forEach(itemId => {
                        const item = [...itemsData.weapons, ...itemsData.armor, ...itemsData.consumables, ...itemsData.materials].find(i => i.id === itemId);
                        if (item && Math.random() < 0.4) {
                            currentLoot.push({ type: 'item', item: { ...item } });
                        }
                    });
                }
                if (Math.random() < 0.15) {
                    const buff = buffsData[Math.floor(Math.random() * buffsData.length)];
                    currentLoot.push({ type: 'buff', buff: { ...buff } });
                }
            }

            // Show Loot Screen
            function showLootScreen() {
                const lootItems = document.getElementById('loot-items');
                lootItems.innerHTML = '';

                currentLoot.forEach(loot => {
                    const lootElement = document.createElement('div');
                    if (loot.type === 'gold') {
                        lootElement.className = 'loot-item';
                        lootElement.innerHTML = `<div class="item-icon">🪙</div><div class="item-name">${loot.amount} золота</div>`;
                    } else if (loot.type === 'item') {
                        lootElement.className = `loot-item loot-quality-common`;
                        lootElement.innerHTML = `<div class="item-icon">${loot.item.icon}</div><div class="item-name">${loot.item.name}</div>`;
                    } else if (loot.type === 'buff') {
                        lootElement.className = 'loot-item';
                        lootElement.innerHTML = `<div class="item-icon">${loot.buff.icon}</div><div class="item-name">${loot.buff.name}</div>`;
                    }
                    lootItems.appendChild(lootElement);
                });

                document.getElementById('take-loot-btn').addEventListener('click', takeAllLoot);

                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                document.querySelector('.tab-btn[data-tab="loot"]').classList.add('active');
                document.getElementById('loot').classList.add('active');
            }

            // Take All Loot
            function takeAllLoot() {
                currentLoot.forEach(loot => {
                    if (loot.type === 'gold') {
                        gold += loot.amount;
                    } else if (loot.type === 'item') {
                        addToInventory(loot.item);
                    } else if (loot.type === 'buff') {
                        applyBuff(loot.buff);
                    }
                });

                enterLocation(currentLocation?.id || 'l1');
                updateCharacterPreview();
                renderInventory();
            }

            // Apply Buff
            function applyBuff(buff) {
                const existingIndex = playerBuffs.findIndex(b => b.id === buff.id);
                if (existingIndex !== -1) {
                    playerBuffs[existingIndex].duration = buff.duration;
                } else {
                    playerBuffs.push({ ...buff });
                }
                updateDerivedStats();
            }

            // Player Defeated
            function playerDefeated() {
                combatActive = false;
                const combatLog = document.getElementById('combat-log');
                combatLog.innerHTML += `<div class="log-entry">Вы потерпели поражение! Вы теряете часть золота.</div>`;
                combatLog.scrollTop = combatLog.scrollHeight;
                gold = Math.max(0, gold - Math.floor(gold * 0.1));
                const combatActions = document.querySelector('.combat-actions');
                combatActions.innerHTML = '<button class="combat-btn" id="exit-combat-btn">Вернуться</button>';
                document.getElementById('exit-combat-btn').addEventListener('click', exitCombat);
            }

            // Attempt Flee
            function attemptFlee() {
                if (!combatActive) return;
                const fleeChance = 0.7;
                if (Math.random() < fleeChance) {
                    combatActive = false;
                    const combatLog = document.getElementById('combat-log');
                    combatLog.innerHTML += `<div class="log-entry">Вы успешно сбежали!</div>`;
                    combatLog.scrollTop = combatLog.scrollHeight;
                    const combatActions = document.querySelector('.combat-actions');
                    combatActions.innerHTML = '<button class="combat-btn" id="exit-combat-btn">Вернуться</button>';
                    document.getElementById('exit-combat-btn').addEventListener('click', exitCombat);
                } else {
                    const combatLog = document.getElementById('combat-log');
                    combatLog.innerHTML += `<div class="log-entry">Вам не удалось сбежать!</div>`;
                    combatLog.scrollTop = combatLog.scrollHeight;
                    setTimeout(enemyAttack, 1000);
                }
            }

            // Exit Combat
            function exitCombat() {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                document.querySelector('.tab-btn[data-tab="location"]').classList.add('active');
                document.getElementById('location').classList.add('active');

                document.getElementById('combat-log').innerHTML = '';
                document.querySelector('.combat-actions').innerHTML = `
                    <button class="combat-btn attack" id="attack-btn">Атака</button>
                    <button class="combat-btn" id="skill-btn">Умение</button>
                    <button class="combat-btn" id="item-btn">Предмет</button>
                    <button class="combat-btn" id="flee-btn">Бегство</button>
                `;
                updateCharacterPreview();
            }

            // Buy Item
            function buyItem(id, type) {
                let item;

                if (type === 'weapon') {
                    item = itemsData.weapons.find(w => w.id === id);
                } else if (type === 'armor') {
                    item = itemsData.armor.find(a => a.id === id);
                } else if (type === 'consumable') {
                    item = itemsData.consumables.find(c => c.id === id);
                } else if (type === 'material') {
                    item = itemsData.materials.find(m => m.id === id);
                } else if (type === 'amulet') {
                    item = itemsData.amulets.find(a => a.id === id);
                }

                if (!item) return;

                if (gold < item.price) {
                    alert('Недостаточно золота!');
                    return;
                }

                gold -= item.price;
                addToInventory(item);

                alert(`Вы купили: ${item.name}`);
                updateCharacterPreview();
                renderShop();
                renderInventory();
            }

            // Sell Item (по списку магазина)
            function sellItem(id, type) {
                const itemIndex = inventory.findIndex(item => item.id === id && item.type === type);
                if (itemIndex === -1) return;

                const item = inventory[itemIndex];
                gold += item.sellPrice * (item.qty || 1);
                inventory.splice(itemIndex, 1);
                alert(`Вы продали: ${item.name} за ${item.sellPrice} золота`);
                updateCharacterPreview();
                renderShop();
                renderInventory();
            }

            // Sell from Inventory (приметы и т.д.)
            function sellItemFromInventory(index) {
                const item = inventory[index];
                if (!item) return;
                const total = item.sellPrice * (item.qty || 1);
                gold += total;
                inventory.splice(index, 1);
                alert(`Вы продали: ${item.name} за ${total} золота`);
                renderInventory();
                renderShop();
                updateCharacterPreview();
            }

            // Add to Inventory
            function addToInventory(item) {
                // ensure qty
                const existingIndex = inventory.findIndex(it => it.id === item.id && it.type === item.type);
                if (existingIndex !== -1) {
                    inventory[existingIndex].qty = (inventory[existingIndex].qty || 1) + 1;
                } else {
                    inventory.push({ ...item, qty: item.qty ? item.qty : 1 });
                }
                renderInventory();
            }

            // Render Inventory
            function renderInventory() {
                inventoryGrid.innerHTML = '';

                for (let i = 0; i < 10; i++) {
                    const slot = document.createElement('div');
                    if (i < inventory.length) {
                        const item = inventory[i];
                        slot.className = 'item-slot';
                        slot.innerHTML = `
                            <div class="item-icon" style="font-size:1.5rem;">${item.icon || ''}</div>
                            <div class="item-name" style="font-size:0.75rem; text-align:center; margin-top:4px;">${item.name}</div>
                            <div class="item-count">${item.qty}</div>
                            <button class="sell-btn-inv" data-index="${i}">Продать</button>
                        `;

                        slot.querySelector('.sell-btn-inv').addEventListener('click', function(e) {
                            e.stopPropagation();
                            const idx = parseInt(this.getAttribute('data-index'));
                            sellItemFromInventory(idx);
                        });

                        // Use/equip
                        slot.addEventListener('click', () => {
                            const item = inventory[i];
                            if (!item) return;
                            if (item.type === 'consumable') {
                                // Use
                                useItem(i);
                            } else if (item.type === 'weapon' || item.type === 'armor') {
                                // Equip/unequip
                                if (equipped[item.type] === item.id) {
                                    // Unequip
                                    equipped[item.type] = null;
                                } else {
                                    equipped[item.type] = item.id;
                                }
                                renderInventory();
                                updateEquipmentSlots();
                                updateDerivedStats();
                            } else if (item.type === 'amulet') {
                                if (equipped.amulet === item.id) {
                                    equipped.amulet = null;
                                } else {
                                    equipped.amulet = item.id;
                                }
                                renderInventory();
                                updateEquipmentSlots();
                                updateDerivedStats();
                            }
                        });
                    } else {
                        slot.className = 'item-slot empty';
                    }
                    inventoryGrid.appendChild(slot);
                }
                // weight
                const weight = inventory.reduce((acc, it) => acc + (it.qty || 1), 0);
                document.getElementById('inventory-weight').textContent = `${weight}/100`;
            }

            // Use Item
            function useItem(index) {
                const item = inventory[index];
                if (!item) return;

                if (item.type === 'consumable') {
                    if (item.effect.health) {
                        const currentHealth = parseInt(healthValue.textContent.split(' / ')[0]);
                        const maxHealth = parseInt(healthValue.textContent.split(' / ')[1]);
                        const newHealth = Math.min(maxHealth, currentHealth + item.effect.health);
                        healthValue.textContent = `${newHealth} / ${maxHealth}`;
                        healthBar.style.width = `${(newHealth / maxHealth) * 100}%`;
                    } else if (item.effect.mana) {
                        const currentMana = parseInt(manaValue.textContent.split(' / ')[0]);
                        const maxMana = parseInt(manaValue.textContent.split(' / ')[1]);
                        const newMana = Math.min(maxMana, currentMana + item.effect.mana);
                        manaValue.textContent = `${newMana} / ${maxMana}`;
                        manaBar.style.width = `${(newMana / maxMana) * 100}%`;
                    } else if (item.effect.buff) {
                        const buff = buffsData.find(b => b.stat === item.effect.buff);
                        if (buff) {
                            applyBuff({ ...buff, value: item.effect.value, duration: item.effect.duration });
                            alert(`Вы получили бафф: ${buff.name}`);
                        }
                    }
                    // remove one quantity
                    inventory[index].qty -= 1;
                    if (inventory[index].qty <= 0) inventory.splice(index, 1);
                    renderInventory();
                } else if (item.type === 'weapon') {
                    if (equipped.weapon) {
                        const oldWeapon = itemsData.weapons.find(w => w.id === equipped.weapon);
                        if (oldWeapon) inventory.push({ ...oldWeapon, qty: 1 });
                    }
                    equipped.weapon = item.id;
                    inventory.splice(index, 1);
                    renderInventory();
                    updateEquipmentSlots();
                    updateDerivedStats();
                } else if (item.type === 'armor') {
                    if (equipped.armor) {
                        const oldArmor = itemsData.armor.find(a => a.id === equipped.armor);
                        if (oldArmor) inventory.push({ ...oldArmor, qty: 1 });
                    }
                    equipped.armor = item.id;
                    inventory.splice(index, 1);
                    renderInventory();
                    updateEquipmentSlots();
                    updateDerivedStats();
                } else if (item.type === 'amulet') {
                    // Equip/unequip amulet
                    if (equipped.amulet) {
                        inventory.push({ ...itemsData.amulets.find(a => a.id === equipped.amulet), qty: 1 });
                    }
                    equipped.amulet = item.id;
                    inventory.splice(index, 1);
                    renderInventory();
                    updateEquipmentSlots();
                    updateDerivedStats();
                }
            }

            // Add XP
            function addXP(amount) {
                characterXP += amount;
                if (characterXP >= xpToNextLevel) {
                    levelUp();
                }
                xpValue.textContent = `${characterXP} / ${xpToNextLevel}`;
                xpBar.style.width = `${(characterXP / xpToNextLevel) * 100}%`;
            }

            // Level Up
            function levelUp() {
                characterLevel++;
                characterXP -= xpToNextLevel;
                xpToNextLevel = Math.floor(xpToNextLevel * 1.5);

                statPoints += 2;
                skillPoints += 1;

                upgradeButtons.forEach(btn => btn.disabled = false);

                document.getElementById('level-number').textContent = characterLevel;
                levelUpNotification.classList.add('show');
                setTimeout(() => levelUpNotification.classList.remove('show'), 3000);

                updateCharacterPreview();
                renderSkills(currentClass);
                renderShop();
                renderLocations();

                if (characterXP >= xpToNextLevel) levelUp();
            }

            // Start Game Button
            startButton.addEventListener('click', function() {
                if (!characterName) {
                    alert('Пожалуйста, введите имя персонажа');
                    nicknameInput.focus();
                    return;
                }

                document.getElementById('creation').style.display = 'none';
                startButton.style.display = 'none';
                document.querySelector('.tab-btn[data-tab="creation"]').style.display = 'none';

                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                document.querySelector('.tab-btn[data-tab="stats"]').classList.add('active');
                document.getElementById('stats').classList.add('active');

                characterCreated = true;
                renderInventory();
                updateCharacterPreview();
                alert(`Приключение начинается, ${characterName}!`);
            });

            // Buff timer
            setInterval(() => {
                if (playerBuffs.length > 0) {
                    playerBuffs.forEach(buff => buff.duration -= 1);
                    playerBuffs = playerBuffs.filter(buff => buff.duration > 0);
                    updateDerivedStats();
                }
            }, 1000);
        });
    </script>
</body>
</html>
